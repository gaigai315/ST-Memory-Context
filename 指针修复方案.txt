è™½ç„¶ä»£ç ä¸­æ›´æ–°äº† API_CONFIG.lastBackfillIndexï¼ˆæœ¬åœ°å˜é‡ï¼‰ï¼Œä¹Ÿæ›´æ–°äº† localStorage å’Œ chatMetadataï¼ˆm.save()ï¼‰ï¼Œä½†æ˜¯ æ²¡æœ‰åŒæ­¥åˆ°äº‘ç«¯/æœåŠ¡ç«¯é…ç½® (settings.json)ã€‚
è€Œåœ¨ autoRunBackfill å‡½æ•°çš„ç¬¬ä¸€è¡Œï¼Œä½ è°ƒç”¨äº† await loadConfig()ã€‚
loadConfig() çš„é€»è¾‘æ˜¯ï¼šå¦‚æœæœåŠ¡ç«¯æœ‰é…ç½®ï¼Œä¼˜å…ˆä½¿ç”¨æœåŠ¡ç«¯çš„é…ç½®è¦†ç›–æœ¬åœ°ã€‚
è¿™å°±å¯¼è‡´äº†ä¸€ä¸ªæ­»å¾ªç¯ï¼š
å¡«è¡¨æˆåŠŸï¼Œæœ¬åœ°æŒ‡é’ˆå˜æˆ 124ã€‚
ä½†æ˜¯æœåŠ¡ç«¯é…ç½®é‡Œçš„æŒ‡é’ˆè¿˜æ˜¯ 122ã€‚
ä¸‹æ¬¡è§¦å‘å¡«è¡¨æ—¶ï¼ŒloadConfig() è¿è¡Œï¼Œå‘ç°æœåŠ¡ç«¯æ˜¯ 122ï¼Œäºæ˜¯æŠŠæœ¬åœ°çš„ 124 è¦†ç›–å› 122ã€‚
ç»“æœå°±æ˜¯æŒ‡é’ˆæ°¸è¿œå¡åœ¨ 122ï¼Œæ— æ³•å‰è¿›ã€‚
æ­¤å¤–ï¼Œ**é™é»˜æ¨¡å¼ï¼ˆSilent Modeï¼‰**çš„ä»£ç é€»è¾‘é¡ºåºä¹Ÿæœ‰é—®é¢˜ï¼šå®ƒå…ˆä¿å­˜äº†å…ƒæ•°æ® (m.save())ï¼Œç„¶åå†æ›´æ–°æŒ‡é’ˆå˜é‡ï¼Œå¯¼è‡´ä¿å­˜åˆ°èŠå¤©è®°å½•é‡Œçš„å…ƒæ•°æ®ä¹Ÿæ˜¯æ—§çš„ã€‚
ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ
æˆ‘å°†ä¿®å¤ autoRunBackfillï¼ˆè‡ªåŠ¨å¡«è¡¨é€»è¾‘ï¼‰å’Œ showBackfillEditPopupï¼ˆå¼¹çª—ç¡®è®¤é€»è¾‘ï¼‰ï¼Œç¡®ä¿åœ¨æ›´æ–°æŒ‡é’ˆåï¼š
ç«‹å³åŒæ­¥åˆ°äº‘ç«¯ (saveAllSettingsToCloud())ï¼Œé˜²æ­¢è¢« loadConfig() è¦†ç›–ã€‚
ä¿®æ­£é™é»˜æ¨¡å¼çš„ä¿å­˜é¡ºåºï¼Œç¡®ä¿ m.save() å†™å…¥çš„æ˜¯æ–°æŒ‡é’ˆã€‚
è¯·æ›¿æ¢ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°ï¼š
1. ä¿®å¤ autoRunBackfill å‡½æ•°
(å¤§çº¦åœ¨ 2330 è¡Œé™„è¿‘)
code
JavaScript
/**
 * è‡ªåŠ¨è¿½æº¯å¡«è¡¨æ ¸å¿ƒå‡½æ•°
 * è¯»å–æŒ‡å®šèŒƒå›´çš„èŠå¤©å†å²ï¼Œè°ƒç”¨AIå¡«å†™è®°å¿†è¡¨æ ¼
 * @param {number} start - èµ·å§‹æ¥¼å±‚ç´¢å¼•
 * @param {number} end - ç»“æŸæ¥¼å±‚ç´¢å¼•
 * @param {boolean} isManual - æ˜¯å¦ä¸ºæ‰‹åŠ¨è§¦å‘ï¼ˆé»˜è®¤falseï¼‰
 */
async function autoRunBackfill(start, end, isManual = false) {
    await loadConfig(); // âœ… 1. å¼ºåˆ¶åˆ·æ–°é…ç½®ï¼Œç¡®ä¿å¼€å…³çŠ¶æ€æœ€æ–°

    // 2. âœ… å¼ºåˆ¶ä» SillyTavern.getContext() è·å–æ•°æ®
    const ctx = window.SillyTavern.getContext(); 
    if (!ctx || !ctx.chat) return;

    console.log(`ğŸ” [è¿½æº¯] æ­£åœ¨è¯»å–æ•°æ®æºï¼Œå…¨é‡æ€»æ¥¼å±‚: ${ctx.chat.length}`);

    // âœ¨ å¼ºåˆ¶åˆ·æ–°æ•°æ®ï¼Œé˜²æ­¢è¯»åˆ°ç©ºçš„
    m.load();

    let userName = (ctx.name1) ? ctx.name1 : 'User';
    let charName = (ctx.name2) ? ctx.name2 : 'Character';

    // 2. âœ¨ Instruction-Last æ¨¡å¼ï¼šSystem Prompt å®Œå…¨ç”±ç”¨æˆ·é…ç½®å†³å®š
    const messages = [];
    messages.push({
        role: 'system',
        content: (PROMPTS.nsfwPrompt || NSFW_UNLOCK)
    });

    // 3. ğŸ—£ï¸ æ„å»ºèŠå¤©å†å²
    const chatSlice = ctx.chat.slice(start, end);
    console.log(`ğŸ“Š [è¿½æº¯] è®¡åˆ’æå– ${start} åˆ° ${end} å±‚ï¼Œå®é™…åˆ‡ç‰‡å¾—åˆ° ${chatSlice.length} æ¡`);

    let validCount = 0;

    chatSlice.forEach(msg => {
        if (msg.isGaigaiData || msg.isGaigaiPrompt) return;

        let content = msg.mes || msg.content || '';
        content = cleanMemoryTags(content);

        // æ ‡ç­¾è¿‡æ»¤
        content = filterContentByTags(content);

        if (content && content.trim()) {
            const isUser = msg.is_user || msg.role === 'user';
            const role = isUser ? 'user' : 'assistant';
            const name = isUser ? userName : (msg.name || charName);

            messages.push({
                role: role,
                content: `${name}: ${content}`
            });
            validCount++;
        }
    });

    if (validCount === 0) {
        if (!C.autoBackfillSilent) await customAlert(`é€‰å®šèŒƒå›´ (${start}-${end}) å†…æ²¡æœ‰æœ‰æ•ˆçš„èŠå¤©å†…å®¹`, 'æç¤º');
        return;
    }

    // 4. ğŸ“‹ Instruction-Lastï¼šå°†æ‰€æœ‰è§„åˆ™å’Œä»»åŠ¡æ”¾åœ¨æœ€å

    // âœ¨âœ¨âœ¨ ä¿®å¤ï¼šæ‰‹åŠ¨æ„å»ºåŒ…å«çŠ¶æ€æ çš„å®Œæ•´è¡¨æ ¼æ•°æ® âœ¨âœ¨âœ¨
    const tableTextRaw = m.getTableText();
    let statusStr = '\n=== ğŸ“‹ å½“å‰è¡¨æ ¼çŠ¶æ€ ===\n';
    m.s.slice(0, 8).forEach((s, i) => {
        const displayName = i === 1 ? 'æ”¯çº¿è¿½è¸ª' : s.n;
        const nextIndex = s.r.length;
        statusStr += `è¡¨${i} ${displayName}: â­ï¸æ–°å¢è¯·ç”¨ç´¢å¼• ${nextIndex}\n`;
    });
    statusStr += '=== çŠ¶æ€ç»“æŸ ===\n';

    const currentTableData = tableTextRaw ? (tableTextRaw + statusStr) : statusStr;

    // âœ¨âœ¨âœ¨ [é‡æ„] Step 1: å‡†å¤‡ä¸Šä¸‹æ–‡ (Context) âœ¨âœ¨âœ¨
    let contextBlock = `ã€èƒŒæ™¯èµ„æ–™ã€‘\nè§’è‰²: ${charName}\nç”¨æˆ·: ${userName}\n`;

    // 1ï¸âƒ£ è§’è‰²å¡ä¿¡æ¯ï¼šdescription, personality, scenario
    if (ctx.characters && ctx.characterId !== undefined && ctx.characters[ctx.characterId]) {
        const char = ctx.characters[ctx.characterId];
        if (char.description) contextBlock += `\n[äººç‰©ç®€ä»‹]\n${char.description}\n`;
        if (char.personality) contextBlock += `\n[æ€§æ ¼/è®¾å®š]\n${char.personality}\n`;
        if (char.scenario) contextBlock += `\n[åœºæ™¯/èƒŒæ™¯]\n${char.scenario}\n`;
    }

    // 2ï¸âƒ£ ä¸–ç•Œä¹¦æ‰«æï¼šæ£€æµ‹å…³é”®è¯è§¦å‘çš„ç›¸å…³è®¾å®š
    let scanTextForWorldInfo = '';
    chatSlice.forEach(msg => scanTextForWorldInfo += (msg.mes || msg.content || '') + '\n');

    let triggeredLore = [];
    let worldInfoList = [];
    try {
        if (ctx.worldInfo && Array.isArray(ctx.worldInfo)) worldInfoList = ctx.worldInfo;
        else if (window.world_info && Array.isArray(window.world_info)) worldInfoList = window.world_info;
    } catch(e) {}

    if (worldInfoList.length > 0 && scanTextForWorldInfo) {
        const lowerText = scanTextForWorldInfo.toLowerCase();
        worldInfoList.forEach(entry => {
            const keysStr = entry.keys || entry.key || '';
            if (!keysStr) return;
            const keys = String(keysStr).split(',').map(k => k.trim().toLowerCase()).filter(k => k);
            if (keys.some(k => lowerText.includes(k))) {
                const content = entry.content || entry.entry || '';
                if (content) triggeredLore.push(`[ç›¸å…³è®¾å®š: ${keys[0]}] ${content}`);
            }
        });
    }

    if (triggeredLore.length > 0) {
        contextBlock += `\nã€ç›¸å…³ä¸–ç•Œè®¾å®šã€‘\n${triggeredLore.join('\n')}`;
    }

    // âœ¨âœ¨âœ¨ [é‡æ„] Step 2: æ›´æ–° System 0 - åŒ…å«ä¸Šä¸‹æ–‡ âœ¨âœ¨âœ¨
    messages[0].content = (PROMPTS.nsfwPrompt || NSFW_UNLOCK) + '\n\n' + contextBlock;
    console.log('âœ… [Contextæ³¨å…¥] è§’è‰²ä¿¡æ¯å’Œä¸–ç•Œè§‚å·²å†™å…¥ System 0');

    // âœ¨âœ¨âœ¨ [åŒ–æ•´ä¸ºé›¶ç­–ç•¥] æ‹†åˆ†å†å²æ€»ç»“ä¸ºå¤šæ¡ç‹¬ç«‹ System æ¶ˆæ¯ âœ¨âœ¨âœ¨
    // Step 2.5: åœ¨èŠå¤©å†å²å‰æ’å…¥å¤šæ¡ System - å­˜å‚¨å‰æƒ…æè¦ + è¡¨æ ¼æ•°æ®
    // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ splice åœ¨ index=1 çš„ä½ç½®æ’å…¥ï¼Œç¡®ä¿é¡ºåºä¸º System 0 -> System 1~N -> èŠå¤©å†å²
    let insertIndex = 1; // ä»ç´¢å¼• 1 å¼€å§‹æ’å…¥ï¼ˆåœ¨ System 0 ä¹‹åï¼‰

    // ç¬¬ä¸€æ­¥ï¼šæ‹†åˆ†æ’å…¥å†å²æ€»ç»“ï¼ˆæ¯æ¡ä½œä¸ºç‹¬ç«‹ System æ¶ˆæ¯ï¼‰
    if (m.sm.has()) {
        const summaryArray = m.sm.loadArray();
        const recentSummaries = summaryArray.slice(-15); // å–æœ€è¿‘ 15 æ¡

        recentSummaries.forEach((item) => {
            messages.splice(insertIndex, 0, {
                role: 'system',
                content: `ã€å‰æƒ…æè¦ - ${item.type || 'å†å²'}ã€‘\n${item.content}`
            });
            insertIndex++; // æ¯æ¬¡æ’å…¥åï¼Œä¸‹ä¸€ä¸ªæ’å…¥ä½ç½®åç§»
        });
        console.log(`âœ… [æ¶ˆæ¯æ‹†åˆ†] å·²æ’å…¥ ${recentSummaries.length} æ¡ç‹¬ç«‹å†å²æ€»ç»“`);
    } else {
        // å¦‚æœæ²¡æœ‰å†å²æ€»ç»“ï¼Œæ’å…¥ä¸€æ¡è¯´æ˜
        messages.splice(insertIndex, 0, {
            role: 'system',
            content: 'ã€å‰æƒ…æè¦ã€‘\nï¼ˆæš‚æ— å†å²æ€»ç»“ï¼‰'
        });
        insertIndex++;
        console.log('âœ… [æ¶ˆæ¯æ‹†åˆ†] æ— å†å²æ€»ç»“ï¼Œå·²æ’å…¥ç©ºæç¤º');
    }

    // ç¬¬äºŒæ­¥ï¼šæ’å…¥å½“å‰è¡¨æ ¼çŠ¶æ€ï¼ˆç‹¬ç«‹æ¶ˆæ¯ï¼‰
    messages.splice(insertIndex, 0, {
        role: 'system',
        content: `ã€å½“å‰è¡¨æ ¼çŠ¶æ€ã€‘\n${currentTableData}`
    });
    insertIndex++;
    console.log('âœ… [æ•°æ®æ³¨å…¥] è¡¨æ ¼æ•°æ®å·²ä½œä¸ºç‹¬ç«‹ System æ¶ˆæ¯æ’å…¥ï¼ˆä½äºèŠå¤©å†å²ä¹‹å‰ï¼‰ï¼Œé¿å… User æ¶ˆæ¯è¿‡é•¿');

    // âœ¨âœ¨âœ¨ [é‡æ„] Step 3: æ„å»º User æŒ‡ä»¤ - åªåŒ…å«ä»»åŠ¡è¦æ±‚ âœ¨âœ¨âœ¨
    // ä½¿ç”¨æ‰¹é‡å¡«è¡¨ä¸“ç”¨æç¤ºè¯
    let rulesContent = PROMPTS.backfillPrompt || DEFAULT_BACKFILL_PROMPT;
    rulesContent = rulesContent.replace(/{{user}}/gi, userName).replace(/{{char}}/gi, charName);

    const finalInstruction = `ã€å¡«è¡¨è§„åˆ™ã€‘\n${rulesContent}

âš¡ ç«‹å³å¼€å§‹æ‰§è¡Œï¼šè¯·ä»å¤´åˆ°å°¾åˆ†æä¸Šè¿°æ‰€æœ‰å‰§æƒ…ï¼ŒæŒ‰ç…§è§„åˆ™æ›´æ–°è¡¨æ ¼ï¼Œå°†ç»“æœè¾“å‡ºåœ¨ <Memory> æ ‡ç­¾ä¸­ã€‚`;

    // âœ¨ æ™ºèƒ½åˆå¹¶ï¼šæ£€æŸ¥æœ€åä¸€æ¡æ¶ˆæ¯çš„è§’è‰²
    const lastMsg = messages[messages.length - 1];
    if (lastMsg && lastMsg.role === 'user') {
        // æœ€åä¸€æ¡æ˜¯ Userï¼šè¿½åŠ åˆ°è¯¥ User æ¶ˆæ¯
        lastMsg.content += '\n\n' + finalInstruction;
        console.log('âœ… [æ™ºèƒ½åˆå¹¶] å·²å°†å¡«è¡¨æŒ‡ä»¤è¿½åŠ åˆ°æœ€åä¸€æ¡ User æ¶ˆæ¯');
    } else {
        // æœ€åä¸€æ¡æ˜¯ Assistant æˆ–å…¶ä»–ï¼šæ–°å¢ä¸€æ¡ User æ¶ˆæ¯
        messages.push({ role: 'user', content: finalInstruction });
        console.log('âœ… [æ™ºèƒ½åˆå¹¶] å·²æ–°å¢ä¸€æ¡ User æ¶ˆæ¯åŒ…å«å¡«è¡¨æŒ‡ä»¤');
    }

    console.log('âœ… [Instruction-Last] Systemè´Ÿè´£èº«ä»½è®¾å®šï¼ŒUserè´Ÿè´£å¡«è¡¨æŒ‡ä»¤');

    console.log(`âš¡ [è¿½æº¯] æ„å»ºå®Œæˆï¼Œå‡†å¤‡å‘é€ ${messages.length} æ¡æ¶ˆæ¯`);

    // 4. æ¢é’ˆ
    window.Gaigai.lastRequestData = {
        chat: JSON.parse(JSON.stringify(messages)),
        timestamp: Date.now(),
        model: API_CONFIG.useIndependentAPI ? API_CONFIG.model : 'Tavern(Direct)'
    };

    // 5. å‘é€
    let result;
    
    // âœ¨ã€æ ¸å¿ƒä¿®å¤ã€‘æ ‡è®°å¼€å§‹ï¼šå‘Šè¯‰ opmt åˆ«åŠ¨æˆ‘çš„æ•°æ®ï¼
    isSummarizing = true; 
    
    try {
        if (API_CONFIG.useIndependentAPI) {
            result = await callIndependentAPI(messages);
        } else {
            console.log('ğŸš€ [ç›´è¿æ¨¡å¼] æ­£åœ¨ä»¥åŸç”Ÿå¤šæ¥¼å±‚æ•°ç»„æ ¼å¼å‘é€...');
            result = await callTavernAPI(messages);
        }
    } catch (e) {
        console.error('è¯·æ±‚å¤±è´¥', e);

        // âš ï¸ å‘ç”Ÿå¼‚å¸¸ï¼Œæ‰“ç ´é™é»˜ï¼Œå¼¹å‡ºé‡è¯•å¼¹çª—
        const errorMsg = `æ‰¹é‡å¡«è¡¨å¤±è´¥ï¼š${e.message}\n\næ˜¯å¦é‡æ–°å°è¯•ï¼Ÿ`;
        const shouldRetry = await customRetryAlert(errorMsg, 'âš ï¸ ç”Ÿæˆå¼‚å¸¸');

        if (shouldRetry) {
            // ç”¨æˆ·é€‰æ‹©é‡è¯•ï¼Œé€’å½’è°ƒç”¨ï¼Œä¼ å…¥ç›¸åŒå‚æ•°
            console.log('ğŸ”„ [ç”¨æˆ·é‡è¯•] æ­£åœ¨é‡æ–°è°ƒç”¨æ‰¹é‡å¡«è¡¨...');
            return autoRunBackfill(start, end, isManual);
        }
        return;
    } finally {
        // âœ¨ã€æ ¸å¿ƒä¿®å¤ã€‘æ ‡è®°ç»“æŸï¼šæ¢å¤æ­£å¸¸çŠ¶æ€
        isSummarizing = false;
    }

    // 6. å¤„ç†ç»“æœ
    if (result && result.success) {
        let aiOutput = unesc(result.summary || result.text || '');

        // âœ… å¼ºåŠ›æå–ï¼šä¼˜å…ˆæå– <Memory> æ ‡ç­¾å†…å®¹
        const tagMatch = aiOutput.match(/<Memory>[\s\S]*?<\/Memory>/i);
        let finalOutput = '';

        if (tagMatch) {
            // æ‰¾åˆ°äº†æ ‡ç­¾ï¼Œåªä¿ç•™æ ‡ç­¾å†…å®¹
            finalOutput = tagMatch[0];
            console.log('âœ… [å†…å®¹æå–] æˆåŠŸæå– <Memory> æ ‡ç­¾ï¼Œå·²è¿‡æ»¤åºŸè¯');
        } else {
            // æ²¡æ‰¾åˆ°æ ‡ç­¾ï¼Œå°è¯•æ™ºèƒ½æå–
            console.warn('âš ï¸ [å†…å®¹æå–] æœªæ‰¾åˆ° <Memory> æ ‡ç­¾ï¼Œå°è¯•æ™ºèƒ½æå–...');

            // ç§»é™¤å¸¸è§çš„å¼€åœºç™½æ¨¡å¼
            aiOutput = aiOutput
                .replace(/^[\s\S]*?(?=<Memory>|insertRow|updateRow)/i, '')  // ç§»é™¤å¼€å¤´åˆ°ç¬¬ä¸€ä¸ªæŒ‡ä»¤ä¹‹å‰çš„å†…å®¹
                .replace(/^(å¥½çš„|æ˜ç™½|æ”¶åˆ°|äº†è§£|ç†è§£|æ ¹æ®|åˆ†æ|æ€»ç»“|ä»¥ä¸‹æ˜¯)[^<\n]*\n*/gim, '')  // ç§»é™¤ç¤¼è²Œç”¨è¯­
                .replace(/^.*?(æ ¹æ®|åŸºäº|æŸ¥çœ‹|é˜…è¯»|åˆ†æ).*?([ï¼Œ,ï¼š:]|ä¹‹å)[^\n]*\n*/gim, '')  // ç§»é™¤åˆ†æè¯´æ˜
                .trim();

            // å¦‚æœä»ç„¶åŒ…å«æŒ‡ä»¤ï¼Œåˆ™ä½¿ç”¨æ¸…ç†åçš„å†…å®¹
            if (aiOutput.includes('insertRow') || aiOutput.includes('updateRow')) {
                finalOutput = `<Memory><!-- ${aiOutput} --></Memory>`;
                console.log('âœ… [å†…å®¹æå–] æ™ºèƒ½æå–æˆåŠŸï¼Œå·²åŒ…è£…ä¸ºæ ‡å‡†æ ¼å¼');
            } else {
                // å®Œå…¨æ²¡æœ‰æœ‰æ•ˆå†…å®¹
                finalOutput = aiOutput;
                console.error('âŒ [å†…å®¹æå–] æœªè¯†åˆ«åˆ°æœ‰æ•ˆçš„è¡¨æ ¼æŒ‡ä»¤');
            }
        }

        if (finalOutput) {
            // âœ¨âœ¨âœ¨ é€»è¾‘åˆ†æµï¼šå¦‚æœæ˜¯æ‰‹åŠ¨æ¨¡å¼ï¼Œç»ä¸é™é»˜ï¼Œä¹Ÿç»ä¸æ˜¾ç¤º"è‡ªåŠ¨ä»»åŠ¡"å¼¹çª—
            if (C.autoBackfillSilent && !isManual) {
                 const cs = prs(finalOutput);
                 if (cs.length > 0) {
                     exe(cs);
                     lastManualEditTime = Date.now();
                     
                     // âœ…âœ…âœ… ä¿®å¤ 1ï¼šè°ƒæ•´é¡ºåºï¼Œå…ˆæ›´æ–°å†…å­˜å˜é‡ï¼Œå†è°ƒç”¨ save
                     API_CONFIG.lastBackfillIndex = end;
                     try { localStorage.setItem(AK, JSON.stringify(API_CONFIG)); } catch (e) {}

                     // âœ…âœ…âœ… ä¿®å¤ 2ï¼šåŒæ­¥åˆ°äº‘ç«¯ï¼Œé˜²æ­¢ loadConfig å›æ»š
                     saveAllSettingsToCloud();

                     // âœ…âœ…âœ… ä¿®å¤ 3ï¼šæœ€åä¿å­˜åˆ° Metadata
                     m.save();
                     updateCurrentSnapshot();
                     
                     if (typeof toastr !== 'undefined') toastr.success(`è‡ªåŠ¨å¡«è¡¨å·²å®Œæˆ`, 'è®°å¿†è¡¨æ ¼', { timeOut: 1000, preventDuplicates: true });

                     // âœ¨âœ¨âœ¨ã€æ ¸å¿ƒä¿®å¤ã€‘æ£€æµ‹å¹¶åˆ·æ–°å½“å‰UI âœ¨âœ¨âœ¨
                     if ($('#g-pop').length > 0) {
                         const activeTab = $('.g-t.act').data('i');
                         // åˆ·æ–°å½“å‰æ˜¾ç¤ºçš„è¡¨æ ¼
                         if (activeTab !== undefined) refreshTable(activeTab);
                         // åŒæ—¶ä¹Ÿåˆ·æ–°ä¸€ä¸‹å„æ ‡ç­¾é¡µçš„ (æ•°å­—) è®¡æ•°
                         m.s.forEach((_, i) => updateTabCount(i));
                         console.log('ğŸ”„ [è‡ªåŠ¨å¡«è¡¨] UI å·²å®æ—¶åˆ·æ–°');
                     }
                 }
            } else {
                 setTimeout(() => {
                     if (typeof showBackfillEditPopup === 'function') {
                         // âœ… ä¼ é€’ end ç»™å¼¹çª—ï¼Œè®©ç”¨æˆ·ç¡®è®¤åå†æ›´æ–°è¿›åº¦
                         // åŒæ—¶ä¼ é€’é‡æ–°ç”Ÿæˆæ‰€éœ€çš„å‚æ•°
                         const regenParams = { start, end, isManual };
                         // âœ… 2. ä»…æ˜¾ç¤ºç¼–è¾‘çª—å£ï¼Œåˆ é™¤å¤šä½™çš„ customAlert
                         showBackfillEditPopup(finalOutput, end, regenParams);
                     }
                 }, 500);
            }
        }
    } else if (result) {
        // âš ï¸ API è¿”å›å¤±è´¥ï¼Œæ‰“ç ´é™é»˜ï¼Œå¼¹å‡ºé‡è¯•å¼¹çª—
        const errorMsg = `æ‰¹é‡å¡«è¡¨å¤±è´¥ï¼š${result.error || 'æœªçŸ¥é”™è¯¯'}\n\næ˜¯å¦é‡æ–°å°è¯•ï¼Ÿ`;
        const shouldRetry = await customRetryAlert(errorMsg, 'âš ï¸ AI ç”Ÿæˆå¤±è´¥');

        if (shouldRetry) {
            // ç”¨æˆ·é€‰æ‹©é‡è¯•ï¼Œé€’å½’è°ƒç”¨ï¼Œä¼ å…¥ç›¸åŒå‚æ•°
            console.log('ğŸ”„ [ç”¨æˆ·é‡è¯•] æ­£åœ¨é‡æ–°è°ƒç”¨æ‰¹é‡å¡«è¡¨...');
            return autoRunBackfill(start, end, isManual);
        }
    }
}
2. ä¿®å¤ showBackfillEditPopup å‡½æ•°
(å¤§çº¦åœ¨ 2670 è¡Œé™„è¿‘)
code
JavaScript
// âœ¨ ç‹¬ç«‹çš„è¿½æº¯ç»“æœç¼–è¾‘å¼¹çª—
function showBackfillEditPopup(content, newIndex = null, regenParams = null) {
    const h = `
        <div class="g-p" style="background:#fff !important; color:#333 !important;">
            <h4>ğŸ“ ç”Ÿæˆç»“æœç¡®è®¤</h4>
            <p style="color:#666; font-size:11px; margin-bottom:10px;">
                AIå·²ç”Ÿæˆå¡«è¡¨æŒ‡ä»¤ï¼Œè¯·ç¡®è®¤æ— è¯¯åç‚¹å‡»å†™å…¥ã€‚<br>
                æ”¯æŒæ‰‹åŠ¨ä¿®æ”¹å†…å®¹ã€‚
            </p>
            <textarea id="bf-popup-editor" style="width:100%; height:350px; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:12px; font-family:inherit; resize:vertical; line-height:1.6; background-color: #ffffff !important; color: #333333 !important;">${esc(content)}</textarea>
            <div style="margin-top:12px; display: flex; gap: 10px;">
                <button id="bf-popup-cancel" style="padding:8px 16px; background:#6c757d; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:12px; flex: 1;">ğŸš« æ”¾å¼ƒ</button>
                ${regenParams ? '<button id="bf-popup-regen" style="padding:8px 16px; background:#17a2b8; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:12px; flex: 1;">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>' : ''}
                <button id="bf-popup-save" style="padding:8px 16px; background:#28a745; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:12px; flex: 2; font-weight:bold;">âœ… ç¡®è®¤å¹¶å†™å…¥</button>
            </div>
        </div>
    `;

    $('#g-backfill-pop').remove();
    const $o = $('<div>', { id: 'g-backfill-pop', class: 'g-ov', css: { 'z-index': '10000005' } });
    const $p = $('<div>', { class: 'g-w', css: { width: '700px', maxWidth: '92vw', height: 'auto' } });

    const $hd = $('<div>', { class: 'g-hd' });
    $hd.append(`<h3 style="color:${UI.tc}; flex:1;">ğŸš€ å†™å…¥ç¡®è®¤</h3>`);

    const $x = $('<button>', { class: 'g-x', text: 'Ã—', css: { background: 'none', border: 'none', color: UI.tc, cursor: 'pointer', fontSize: '22px' } }).on('click', () => $o.remove());
    $hd.append($x);

    const $bd = $('<div>', { class: 'g-bd', html: h });
    $p.append($hd, $bd);
    $o.append($p);
    $('body').append($o);

    setTimeout(() => {
        // âœ… å–æ¶ˆæŒ‰é’® - ä¸ä¿å­˜æ•°æ®ï¼Œä¸æ›´æ–°è¿›åº¦
        $('#bf-popup-cancel').on('click', () => {
            $o.remove();
        });

        // âœ… é‡æ–°ç”ŸæˆæŒ‰é’®
        if (regenParams) {
            $('#bf-popup-regen').on('click', async function() {
                const $btn = $(this);
                const originalText = $btn.text();

                // ç¦ç”¨æ‰€æœ‰æŒ‰é’®
                $('#bf-popup-cancel, #bf-popup-regen, #bf-popup-save').prop('disabled', true);
                $btn.text('ç”Ÿæˆä¸­...');

                try {
                    console.log('ğŸ”„ [é‡æ–°ç”Ÿæˆ] æ­£åœ¨é‡æ–°è°ƒç”¨ autoRunBackfill...');

                    // ä¸´æ—¶æ ‡è®°ï¼šç”Ÿæˆçš„å†…å®¹å°†é€šè¿‡è¿”å›å€¼è·å–ï¼Œè€Œä¸æ˜¯å¼¹å‡ºæ–°çª—å£
                    window._isRegeneratingBackfill = true;

                    // æ„å»ºæ¶ˆæ¯æ•°ç»„ï¼ˆå¤åˆ¶è‡ª autoRunBackfill çš„é€»è¾‘ï¼‰
                    const ctx = window.SillyTavern.getContext();
                    if (!ctx || !ctx.chat) {
                        throw new Error('æ— æ³•è®¿é—®èŠå¤©ä¸Šä¸‹æ–‡');
                    }

                    let userName = (ctx.name1) ? ctx.name1 : 'User';
                    let charName = (ctx.name2) ? ctx.name2 : 'Character';

                    // âœ¨ Instruction-Last æ¨¡å¼ï¼šSystem Prompt å®Œå…¨ç”±ç”¨æˆ·é…ç½®å†³å®š
                    const messages = [{
                        role: 'system',
                        content: (PROMPTS.nsfwPrompt || NSFW_UNLOCK)
                    }];

                    // æ„å»ºèŠå¤©å†å²
                    const chatSlice = ctx.chat.slice(regenParams.start, regenParams.end);
                    chatSlice.forEach(msg => {
                        if (msg.isGaigaiData || msg.isGaigaiPrompt) return;
                        let content = msg.mes || msg.content || '';
                        content = cleanMemoryTags(content);

                        // æ ‡ç­¾è¿‡æ»¤
                        content = filterContentByTags(content);

                        if (content && content.trim()) {
                            const isUser = msg.is_user || msg.role === 'user';
                            const role = isUser ? 'user' : 'assistant';
                            const name = isUser ? userName : (msg.name || charName);
                            messages.push({ role: role, content: `${name}: ${content}` });
                        }
                    });

                    // ğŸ“‹ Instruction-Lastï¼šå°†æ‰€æœ‰è§„åˆ™æ”¾åœ¨æœ€å

                    // âœ¨âœ¨âœ¨ ä¿®å¤ï¼šæ‰‹åŠ¨æ„å»ºåŒ…å«çŠ¶æ€æ çš„å®Œæ•´è¡¨æ ¼æ•°æ® âœ¨âœ¨âœ¨
                    const tableTextRaw = m.getTableText();
                    let statusStr = '\n=== ğŸ“‹ å½“å‰è¡¨æ ¼çŠ¶æ€ ===\n';
                    m.s.slice(0, 8).forEach((s, i) => {
                        const displayName = i === 1 ? 'æ”¯çº¿è¿½è¸ª' : s.n;
                        const nextIndex = s.r.length;
                        statusStr += `è¡¨${i} ${displayName}: â­ï¸æ–°å¢è¯·ç”¨ç´¢å¼• ${nextIndex}\n`;
                    });
                    statusStr += '=== çŠ¶æ€ç»“æŸ ===\n';

                    const currentTableData = tableTextRaw ? (tableTextRaw + statusStr) : statusStr;

                    let rulesContent = PROMPTS.tablePrompt || DEFAULT_TABLE_PROMPT;
                    rulesContent = rulesContent.replace(/{{user}}/gi, userName).replace(/{{char}}/gi, charName);

                    let contextInfo = '';
                    if (ctx.characters && ctx.characterId !== undefined && ctx.characters[ctx.characterId]) {
                        const char = ctx.characters[ctx.characterId];
                        if (char.description) contextInfo += `[äººç‰©ç®€ä»‹]\n${char.description}\n`;
                    }

                    // âœ¨âœ¨âœ¨ [åŒ–æ•´ä¸ºé›¶ç­–ç•¥] æ’å…¥å†å²æ€»ç»“ä¸ºå¤šæ¡ç‹¬ç«‹ System æ¶ˆæ¯ âœ¨âœ¨âœ¨
                    // åœ¨å·²æœ‰çš„ System 0 (NSFW Prompt) ä¹‹åï¼Œæ’å…¥å†å²æ€»ç»“å’Œè¡¨æ ¼æ•°æ®
                    let insertIndex = 1; // ä»ç´¢å¼• 1 å¼€å§‹æ’å…¥ï¼ˆåœ¨ System 0 ä¹‹åï¼‰

                    // ç¬¬ä¸€æ­¥ï¼šæ‹†åˆ†æ’å…¥å†å²æ€»ç»“ï¼ˆæ¯æ¡ä½œä¸ºç‹¬ç«‹ System æ¶ˆæ¯ï¼‰
                    if (m.sm.has()) {
                        const summaryArray = m.sm.loadArray();
                        const recentSummaries = summaryArray.slice(-15); // å–æœ€è¿‘ 15 æ¡

                        recentSummaries.forEach((item) => {
                            messages.splice(insertIndex, 0, {
                                role: 'system',
                                content: `ã€å‰æƒ…æè¦ - ${item.type || 'å†å²'}ã€‘\n${item.content}`
                            });
                            insertIndex++;
                        });
                        console.log(`âœ… [é‡æ–°ç”Ÿæˆ-æ¶ˆæ¯æ‹†åˆ†] å·²æ’å…¥ ${recentSummaries.length} æ¡ç‹¬ç«‹å†å²æ€»ç»“`);
                    } else {
                        messages.splice(insertIndex, 0, {
                            role: 'system',
                            content: 'ã€å‰æƒ…æè¦ã€‘\nï¼ˆæš‚æ— å†å²æ€»ç»“ï¼‰'
                        });
                        insertIndex++;
                    }

                    // ç¬¬äºŒæ­¥ï¼šæ’å…¥å½“å‰è¡¨æ ¼çŠ¶æ€ï¼ˆç‹¬ç«‹æ¶ˆæ¯ï¼‰
                    messages.splice(insertIndex, 0, {
                        role: 'system',
                        content: `ã€å½“å‰è¡¨æ ¼çŠ¶æ€ã€‘\n${currentTableData}`
                    });
                    insertIndex++;

                    // ç¬¬ä¸‰æ­¥ï¼šæ’å…¥è§’è‰²ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (contextInfo) {
                        messages.splice(insertIndex, 0, {
                            role: 'system',
                            content: `ã€è§’è‰²ä¿¡æ¯ã€‘\n${contextInfo}`
                        });
                        insertIndex++;
                    }

                    // æ„å»º User æŒ‡ä»¤ï¼ˆåªåŒ…å«è§„åˆ™ï¼Œä¸åŒ…å«æ•°æ®ï¼‰
                    const finalInstruction = `${rulesContent}

âš¡ ç«‹å³å¼€å§‹æ‰§è¡Œï¼šè¯·ä»å¤´åˆ°å°¾åˆ†æä¸Šè¿°æ‰€æœ‰å‰§æƒ…ï¼ŒæŒ‰ç…§è§„åˆ™æ›´æ–°è¡¨æ ¼ï¼Œå°†ç»“æœè¾“å‡ºåœ¨ <Memory> æ ‡ç­¾ä¸­ã€‚`;

                    messages.push({ role: 'user', content: finalInstruction });
                    console.log('âœ… [Instruction-Last] é‡æ–°ç”Ÿæˆå·²é‡‡ç”¨åç½®æŒ‡ä»¤æ¨¡å¼');

                    // é‡æ–°è°ƒç”¨ API
                    isSummarizing = true;
                    let result;
                    try {
                        if (API_CONFIG.useIndependentAPI) {
                            result = await callIndependentAPI(messages);
                        } else {
                            result = await callTavernAPI(messages);
                        }
                    } finally {
                        isSummarizing = false;
                    }

                    if (result && result.success) {
                        let aiOutput = unesc(result.summary || result.text || '');

                        // âœ… å¼ºåŠ›æå–ï¼šä¼˜å…ˆæå– <Memory> æ ‡ç­¾å†…å®¹
                        const tagMatch = aiOutput.match(/<Memory>[\s\S]*?<\/Memory>/i);
                        let finalOutput = '';

                        if (tagMatch) {
                            // æ‰¾åˆ°äº†æ ‡ç­¾ï¼Œåªä¿ç•™æ ‡ç­¾å†…å®¹
                            finalOutput = tagMatch[0];
                            console.log('âœ… [é‡æ–°ç”Ÿæˆ-å†…å®¹æå–] æˆåŠŸæå– <Memory> æ ‡ç­¾ï¼Œå·²è¿‡æ»¤åºŸè¯');
                        } else {
                            // æ²¡æ‰¾åˆ°æ ‡ç­¾ï¼Œå°è¯•æ™ºèƒ½æå–
                            console.warn('âš ï¸ [é‡æ–°ç”Ÿæˆ-å†…å®¹æå–] æœªæ‰¾åˆ° <Memory> æ ‡ç­¾ï¼Œå°è¯•æ™ºèƒ½æå–...');

                            // ç§»é™¤å¸¸è§çš„å¼€åœºç™½æ¨¡å¼
                            aiOutput = aiOutput
                                .replace(/^[\s\S]*?(?=<Memory>|insertRow|updateRow)/i, '')
                                .replace(/^(å¥½çš„|æ˜ç™½|æ”¶åˆ°|äº†è§£|ç†è§£|æ ¹æ®|åˆ†æ|æ€»ç»“|ä»¥ä¸‹æ˜¯)[^<\n]*\n*/gim, '')
                                .replace(/^.*?(æ ¹æ®|åŸºäº|æŸ¥çœ‹|é˜…è¯»|åˆ†æ).*?([ï¼Œ,ï¼š:]|ä¹‹å)[^\n]*\n*/gim, '')
                                .trim();

                            // å¦‚æœä»ç„¶åŒ…å«æŒ‡ä»¤ï¼Œåˆ™ä½¿ç”¨æ¸…ç†åçš„å†…å®¹
                            if (aiOutput.includes('insertRow') || aiOutput.includes('updateRow')) {
                                finalOutput = `<Memory><!-- ${aiOutput} --></Memory>`;
                                console.log('âœ… [é‡æ–°ç”Ÿæˆ-å†…å®¹æå–] æ™ºèƒ½æå–æˆåŠŸï¼Œå·²åŒ…è£…ä¸ºæ ‡å‡†æ ¼å¼');
                            } else {
                                finalOutput = aiOutput;
                                console.error('âŒ [é‡æ–°ç”Ÿæˆ-å†…å®¹æå–] æœªè¯†åˆ«åˆ°æœ‰æ•ˆçš„è¡¨æ ¼æŒ‡ä»¤');
                            }
                        }

                        if (finalOutput) {
                            // æ›´æ–° textarea
                            $('#bf-popup-editor').val(finalOutput);
                            if (typeof toastr !== 'undefined') {
                                toastr.success('å†…å®¹å·²åˆ·æ–°', 'é‡æ–°ç”Ÿæˆ', { timeOut: 1000, preventDuplicates: true });
                            }
                        } else {
                            throw new Error('é‡æ–°ç”Ÿæˆçš„å†…å®¹ä¸ºç©ºæˆ–æ— æ•ˆ');
                        }
                    } else {
                        throw new Error(result.error || 'API è¿”å›å¤±è´¥');
                    }

                } catch (error) {
                    console.error('âŒ [é‡æ–°ç”Ÿæˆå¤±è´¥]', error);

                    // âš ï¸ ä½¿ç”¨é‡è¯•å¼¹çª—
                    const errorMsg = `é‡æ–°ç”Ÿæˆå¤±è´¥ï¼š${error.message}\n\næ˜¯å¦é‡æ–°å°è¯•ï¼Ÿ`;
                    const shouldRetry = await customRetryAlert(errorMsg, 'âš ï¸ ç”Ÿæˆå¤±è´¥');

                    if (shouldRetry) {
                        // ç”¨æˆ·é€‰æ‹©é‡è¯•ï¼Œå…³é—­å½“å‰å¼¹çª—ï¼Œè°ƒç”¨ autoRunBackfill
                        console.log('ğŸ”„ [ç”¨æˆ·é‡è¯•] å…³é—­å¼¹çª—å¹¶é‡æ–°è°ƒç”¨æ‰¹é‡å¡«è¡¨...');
                        $o.remove();  // å…³é—­å½“å‰å¼¹çª—
                        await autoRunBackfill(regenParams.start, regenParams.end, regenParams.isManual);
                        return;  // é€€å‡ºå½“å‰å‡½æ•°
                    }
                } finally {
                    window._isRegeneratingBackfill = false;
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    $('#bf-popup-cancel, #bf-popup-regen, #bf-popup-save').prop('disabled', false);
                    $btn.text(originalText);
                }
            });
        }

        // âœ… ç¡®è®¤ä¿å­˜æŒ‰é’® - ä¿å­˜æ•°æ®å¹¶æ›´æ–°è¿›åº¦
        $('#bf-popup-save').on('click', async function() {
            const finalContent = $('#bf-popup-editor').val().trim();
            if (!finalContent) return;

            const cs = prs(finalContent);
            if (cs.length === 0) {
                await customAlert('âš ï¸ æœªè¯†åˆ«åˆ°æœ‰æ•ˆçš„è¡¨æ ¼æŒ‡ä»¤ï¼', 'è§£æå¤±è´¥');
                return;
            }

            // æ‰§è¡Œå†™å…¥
            exe(cs);
            lastManualEditTime = Date.now();

            // âœ… åªæœ‰åœ¨ç”¨æˆ·ç¡®è®¤ä¿å­˜æ—¶ï¼Œæ‰æ›´æ–°è¿›åº¦æŒ‡é’ˆ
            if (newIndex !== null) {
                API_CONFIG.lastBackfillIndex = newIndex;
                try { localStorage.setItem(AK, JSON.stringify(API_CONFIG)); } catch (e) {}
                console.log(`âœ… [è¿›åº¦æ›´æ–°] æ‰¹é‡å¡«è¡¨è¿›åº¦å·²æ›´æ–°è‡³: ${newIndex}`);
            }

            // âœ…âœ…âœ… ä¿®å¤ï¼šåŒæ­¥åˆ°äº‘ç«¯ï¼Œé˜²æ­¢ä¸‹æ¬¡ loadConfig å›æ»š
            saveAllSettingsToCloud();

            // âœ… å…³é”®ä¿®å¤ï¼šåœ¨æ›´æ–°è¿›åº¦åå†ä¿å­˜ï¼Œç¡®ä¿è¿›åº¦è¢«å†™å…¥å…ƒæ•°æ®
            m.save();
            updateCurrentSnapshot();

            await customAlert('âœ… æ•°æ®å·²å†™å…¥', 'å®Œæˆ');
            $o.remove(); // å…³é—­å¼¹çª—

            // âœ¨âœ¨âœ¨ æ ¸å¿ƒä¿®å¤ 2ï¼šä¿å­˜æˆåŠŸåï¼Œè‡ªåŠ¨è¿”å›ä¸»ç•Œé¢ï¼Œè§£å†³çŠ¶æ€æ»ç•™é—®é¢˜
            shw();
        });
    }, 100);
}